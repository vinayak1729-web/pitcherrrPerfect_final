<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseball Commentary</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Bungee+Outline&family=Bungee+Shade&family=Bungee+Inline&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
/* ... CSS Styles (same as before) ... */
body {
    font-family: 'Bungee', sans-serif;
    background-color: #f0f0f0;
    background-image:
        linear-gradient(45deg, rgba(220, 220, 220, 0.1) 25%, transparent 25%, transparent 50%, rgba(220, 220, 220, 0.1) 50%, rgba(220, 220, 220, 0.1) 75%, transparent 75%, transparent);
    background-size: 20px 20px;
    color: #333;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    box-sizing: border-box; /* Include padding and border in element's total width and height */
}

.container {
    width: 95%;
    max-width: 1200px;
    background-color: #fff;
    padding: 20px;
    border: 2px solid #222;
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.1);
}

h1 {
    font-family: 'Bungee', cursive;
    text-align: center;
    color: #222;
    margin-bottom: 20px;
    letter-spacing: 2px;
    text-transform: uppercase;
}

.game-info {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin-bottom: 20px;
}

.team-info {
    text-align: center;
    width: 30%;
}

.team-logo {
    max-width: 100px;
    height: auto;
    margin-bottom: 10px;
}

.score-info{
    text-align: center;
    width: 30%;
}
.score {
    font-size: 1.5rem;
    font-weight: bold;
}

#commentary-output {
    white-space: pre-line;
    border: 1px solid #ddd;
    padding: 10px;
    margin: 10px 0;
    font-size: 1rem;
    line-height: 1.6;
    max-height: 400px;
    overflow-y: auto;
}

#commentary-output p{
    margin: 5px 0;
}

.button-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

button {
    background-color: #222;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    font-family: 'Bungee', sans-serif;
    border-radius: 0;
    font-size: 1rem;
    letter-spacing: 1px;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #555;
}

select{
    background-color: #222;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    font-family: 'Bungee', sans-serif;
    border-radius: 0;
    font-size: 1rem;
    letter-spacing: 1px;
    transition: background-color 0.3s ease;
}

select:hover{
    background-color: #555;
}

.highlighted {
    background-color: yellow;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>⚾ Baseball Highlights Reel ⚾</h1>
        {% if game_data %}
            <div class="game-info">
                <div class="team-info">
                    <img src="{{ game_data.away_team_logo }}" alt="{{ game_data.away_team }} Logo" class="team-logo">
                    <p>{{ game_data.away_team }}</p>
                </div>
                <div class="score-info">
                   <p> VS </p>
                   <p class="score">{{ game_data.away_score }} - {{ game_data.home_score }}</p>
                </div>
                 <div class="team-info">
                    <img src="{{ game_data.home_team_logo }}" alt="{{ game_data.home_team }} Logo" class="team-logo">
                    <p>{{ game_data.home_team }}</p>
                </div>
             </div>
        {% else %}
            <p>No game data available.</p>
        {% endif %}
       <div class="button-container">
          <button id="start-ai-button" onclick="startStream('{{ game_pk }}')">Start AI Commentary</button>
            <button id="stop-ai-button" style="display:none" onclick="stopStream()">Stop AI Commentary</button>
         </div>
         <div class="button-container">
            <select id="language-select" onchange="handleLanguageChange()">
                <option value="en">English</option>
                <option value="es">Español</option>
                <option value="ja">日本語</option>
                <option value="hi">हिंदी</option>
                <option value="fr">Français</option>
                <option value="de">Deutsch</option>
                <option value="it">Italiano</option>
                <option value="ko">한국어</option>
                <option value="zh-cn">中文</option>
                
               
            </select>
            <select id="gender-select">
                <option value="male">Male Voice</option>
                <option value="female">Female Voice</option>
            </select>
            
            <button id="start-speech">Start Speech</button>
            <button id="stop-speech">Stop Speech</button>
        </div>
        <audio id="speech-audio" style="display: none"></audio>
        <div id="commentary-output">
          <p> Commentary will appear here </p>
        </div>
    </div>
     <script>
    // Global state variables
let currentWordIndex = 0;
let words = [];
let isSpeaking = false;
let eventSource = null;
let isStreaming = false;
let currentLanguage = 'en';

// Event Listeners
document.getElementById('start-speech').addEventListener('click', () => {
    const text = document.getElementById('commentary-output').innerText;
    const language = document.getElementById('language-select').value;
    startSpeech(text, language);
});

document.getElementById('stop-speech').addEventListener('click', stopSpeech);

document.getElementById('language-select').addEventListener('change', handleLanguageChange);

// Speech Control Functions
function handleLanguageChange() {
    const newLanguage = document.getElementById('language-select').value;
    if (currentLanguage !== newLanguage) {
        currentLanguage = newLanguage;
        const text = document.getElementById('commentary-output').innerText;
        
        if (isSpeaking) {
            stopSpeech();
        }
        
        translateAndSpeak(text, newLanguage);
    }
}

function translateAndSpeak(text, language) {
    fetch('/speak', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `text=${encodeURIComponent(text)}&language=${language}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('commentary-output').innerHTML = data.spoken_text;
        startSpeech(data.spoken_text, language);
    })
    .catch(error => {
        console.error('Translation/Speech Error:', error);
        document.getElementById('commentary-output').innerHTML += 
            `<p>Error: Could not process speech in ${language}</p>`;
    });
}
let currentAudio = null;

function startSpeech(text, language) {
    if (currentAudio) {
        stopSpeech();
    }
    
    const gender = document.getElementById('gender-select').value;
    
    fetch('/speak', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `text=${encodeURIComponent(text)}&language=${language}&gender=${gender}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('TTS Error:', data.error);
            return;
        }
        
        const audio = document.getElementById('speech-audio');
        audio.src = data.audio_url;
        currentAudio = audio;
        
        // Update text with translation
        document.getElementById('commentary-output').innerHTML = data.text;
        
        // Start playing
        audio.play();
        
        // Show stop button
        document.getElementById('start-speech').style.display = 'none';
        document.getElementById('stop-speech').style.display = 'inline';
        
        // Handle audio completion
        audio.onended = () => {
            stopSpeech();
        };
    })
    .catch(error => console.error('Speech Error:', error));
}

function stopSpeech() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    document.getElementById('stop-speech').style.display = 'none';
    document.getElementById('start-speech').style.display = 'inline';
}

// Add event listener for audio element
document.getElementById('speech-audio').addEventListener('error', (e) => {
    console.error('Audio Error:', e);
    stopSpeech();
});
function speakText(spoken_words) {
    if (!isSpeaking || currentWordIndex >= spoken_words.length) {
        isSpeaking = false;
        document.getElementById('stop-speech').style.display = 'none';
        document.getElementById('start-speech').style.display = 'inline';
        return;
    }

    const wordElement = document.getElementById(`word-${currentWordIndex}`);
    if (wordElement) {
        wordElement.classList.add('highlighted');
        setTimeout(() => {
            wordElement.classList.remove('highlighted');
            currentWordIndex++;
            speakText(spoken_words);
        }, 500);
    } else {
        currentWordIndex++;
        speakText(spoken_words);
    }
}

// Stream Control Functions
function startStream(gamePk) {
    if (isStreaming) return;
    
    isStreaming = true;
    const commentaryDiv = document.getElementById('commentary-output');
    commentaryDiv.innerHTML = '<p>Loading AI commentary...</p>';
    document.getElementById('start-ai-button').style.display = 'none';
    document.getElementById('stop-ai-button').style.display = 'inline';
    
    const streamUrl = `/stream_ai_commentary/${gamePk}?language=${currentLanguage}`;
    eventSource = new EventSource(streamUrl);
    
    eventSource.onmessage = handleStreamMessage;
    eventSource.onerror = handleStreamError;
}

function handleStreamMessage(event) {
    const commentaryDiv = document.getElementById('commentary-output');
    
    if (event.data.startsWith('Error during chat') || event.data.trim() === '') {
        handleStreamError();
    } else {
        commentaryDiv.innerHTML += event.data;
        scrollToBottom(commentaryDiv);
    }
}

function handleStreamError() {
    console.error('Stream error occurred');
    const commentaryDiv = document.getElementById('commentary-output');
    commentaryDiv.innerHTML += '<p>Switching to fallback commentary...</p>';
    loadFallbackCommentary(gamePk);
    cleanupStream();
}

function stopStream() {
    if (eventSource) {
        eventSource.close();
        cleanupStream();
        document.getElementById('commentary-output').innerHTML += '<p>Stream stopped.</p>';
    }
}

function cleanupStream() {
    eventSource = null;
    isStreaming = false;
    document.getElementById('start-ai-button').style.display = 'inline';
    document.getElementById('stop-ai-button').style.display = 'none';
}

function loadFallbackCommentary(gamePk) {
    fetch(`/get_ai_commentary/${gamePk}`)
        .then(response => response.json())
        .then(data => {
            const commentaryDiv = document.getElementById('commentary-output');
            commentaryDiv.innerHTML = '';
            data.commentary.forEach(line => {
                commentaryDiv.innerHTML += `<p>${line}</p>`;
            });
            scrollToBottom(commentaryDiv);
        })
        .catch(error => {
            console.error('Fallback Commentary Error:', error);
            document.getElementById('commentary-output').innerHTML += 
                '<p>Error: Could not load fallback commentary.</p>';
        });
}

function scrollToBottom(element) {
    element.scrollTop = element.scrollHeight;
}


      </script>

</body>
</html>